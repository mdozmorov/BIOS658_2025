---
title: "Supervised Learning: Methods for Analyzing Gene Expression Data"
# subtitle: "Using ggplot2 and dplyr"
author: "Mikhail Dozmorov"
institute: "Virginia Commonwealth University"
date: "`r Sys.Date()`"
output:
  xaringan::moon_reader:
    lib_dir: libs
    css: ["xaringan-themer.css"]
    nature:
      ratio: '16:9'
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

```{r xaringan-themer, include = FALSE}
library(xaringanthemer)
mono_light(
  base_color = "midnightblue",
  header_font_google = google_font("Josefin Sans"),
  text_font_google   = google_font("Montserrat", "500", "500i"),
  code_font_google   = google_font("Droid Mono"),
  link_color = "#8B1A1A", #firebrick4, "deepskyblue1"
  text_font_size = "28px"
)
library(dplyr)
library(ggplot2)
```

<!-- HTML style block -->
<style>
.large { font-size: 130%; }
.small { font-size: 70%; }
.tiny { font-size: 40%; }
</style>


## Linear regression overview

We measure tumor grade and expression of gene 1. We are interested in:

1. How useful was expression of gene 1 for predicting tumor grade? $R^2$
2. Was that relationship due to chance? $p-value$

```{r echo=FALSE, fig.height=5, fig.align='center'}
set.seed(1)
x <- seq(1, 10) %>% jitter(amount = 1)
y <- seq(5, 14) %>% jitter(amount = 1)
plot(x, y, xlab = "Tumor grade", ylab = "Gene 1")
```

---
## T-test

```{r echo=FALSE, fig.height=7, fig.align='center'}
set.seed(1)
gene1 <- rnorm(4, 5)
gene2 <- rnorm(4, 10)
x <- c(rep(1, 4), rep(2, 4))
plot(x, c(gene1, gene2), xlim = c(0, 3), ylim = c(0, 15), xlab = ("Status: 1 - normal, 2 - tumor"), ylab = "Gene expression")
```

The goal of t-test is to compare means and see if they are significantly different from each other.

---
## T-test in terms of linear regression

- Calculate the overall mean
- Calculate the sum of squared residuals around the mean $SS_{mean}$

```{r echo=FALSE, fig.height=5, fig.align='center'}
set.seed(1)
gene1 <- rnorm(4, 5)
gene2 <- rnorm(4, 10)
x <- c(rep(1, 4), rep(2, 4))
plot(x, c(gene1, gene2), xlim = c(0, 3), ylim = c(0, 15), xlab = ("Status: 1 - normal, 2 - tumor"), ylab = "Gene expression")
abline(h = mean(c(gene1, gene2)))
```

---
## T-test in terms of linear regression

- Fit a line to the data, separately for each group (mean = the least squares fit to the group of data)
- For each group, we can calculate $SS_{fit}$

```{r echo=FALSE, fig.height=5, fig.align='center'}
set.seed(1)
gene1 <- rnorm(4, 5)
gene2 <- rnorm(4, 10)
x <- c(rep(1, 4), rep(2, 4))
plot(x, c(gene1, gene2), xlim = c(0, 3), ylim = c(0, 15), xlab = ("Status: 1 - normal, 2 - tumor"), ylab = "Gene expression")
lines(x = c(0.5, 1.5), y = c(mean(gene1), mean(gene1)) )
lines(x = c(1.5, 2.5), y = c(mean(gene2), mean(gene2)) )
text(x = 1.6, y = mean(gene1), "mu_1")
text(x = 2.6, y = mean(gene2), "mu_2")
```

---
## T-test in terms of linear regression

- Combine two lines into a single equation. 

- This will make the steps for computing F-statistics exactly the same as for the regression

```{r eval=FALSE, echo=TRUE}
# Combines both lines for the first group
y_11 = 1 * mu_1 + 0 * mu_2 + residual_11
y_12 = 1 * mu_1 + 0 * mu_2 + residual_12
y_13 = 1 * mu_1 + 0 * mu_2 + residual_13
y_14 = 1 * mu_1 + 0 * mu_2 + residual_14
# Combines both lines for the second group
y_21 = 0 * mu_1 + 1 * mu_2 + residual_21
y_22 = 0 * mu_1 + 1 * mu_2 + residual_22
y_23 = 0 * mu_1 + 1 * mu_2 + residual_23
y_24 = 0 * mu_1 + 1 * mu_2 + residual_24
```

---
## Design matrix

- 1's and 0's serve as "switches" for each group. 

- This is our design matrix $X$, one column per group.

```
1  0
1  0
1  0
1  0
0  1
0  1
0  1
0  1
```

---
## Connecting Design Matrices and F-statistics

We can express the model as

$$Y = X \mu + \varepsilon$$

Then calculate

$$F = \frac{(SS_{\text{mean}} - SS_{\text{fit}})/(p_{\text{fit}} - p_{\text{mean}})}{SS_{\text{fit}}/(n - p_{\text{fit}})}$$

where:

* $p_{\text{mean}} = 1$ (overall mean)
* $p_{\text{fit}} = 2$ (two group means)

This generalizes naturally to **ANOVA** when $k > 2$ groups.

---
## A more common design matrix

```
1  0
1  0
1  0
1  0
1  1
1  1
1  1
1  1
```

- In this setup, all measurements contribute to the mean for the first group

- But only the measurements from the second group contribute to the _difference_ between the first and the second group

- So the second column serves as a switch for the offset from the mean for the second group

---
## A more common design matrix

```{r echo=FALSE, fig.height=5, fig.align='center'}
set.seed(1)
gene1 <- rnorm(4, 5)
gene2 <- rnorm(4, 10)
x <- c(rep(1, 4), rep(2, 4))
plot(x, c(gene1, gene2), xlim = c(0, 3), ylim = c(0, 15), xlab = ("Status: 1 - normal, 2 - tumor"), ylab = "Gene expression")
lines(x = c(0.5, 3.0), y = c(mean(gene1), mean(gene1)) )
lines(x = c(1.5, 2.5), y = c(mean(gene2), mean(gene2)) )
text(x = 0.6, y = mean(gene2), "difference = mu_2 - mu_1")
```

---
## A more common design matrix

```{r eval=FALSE, echo=TRUE}
# Combines both lines for the first group
y_11 = 1 * mu_1 + 0 * difference_{mu_2 - mu_1} + residual_11
y_12 = 1 * mu_1 + 0 * difference_{mu_2 - mu_1} + residual_12
y_13 = 1 * mu_1 + 0 * difference_{mu_2 - mu_1} + residual_13
y_14 = 1 * mu_1 + 0 * difference_{mu_2 - mu_1} + residual_14
# Combines both lines for the second group
y_21 = 1 * mu_1 + 1 * difference_{mu_2 - mu_1} + residual_21
y_22 = 1 * mu_1 + 1 * difference_{mu_2 - mu_1} + residual_22
y_23 = 1 * mu_1 + 1 * difference_{mu_2 - mu_1} + residual_23
y_24 = 1 * mu_1 + 1 * difference_{mu_2 - mu_1} + residual_24
```

- Same way to calculate $SS_{mean}$ and $SS_{fit}$

- Same number of equations

- Same number of parameters

---
## Power of design matrices

- Say, in addition to group 1 and group 2, you have age variable.

```{r echo=FALSE, fig.height=5, fig.align='center'}
set.seed(1)
x <- 1:4
gene1 <- rnorm(4, 6) * x
gene2 <- rnorm(4, 10) * x
plot(x, gene1, col = "red", pch = 19, xlim = c(0, 5), ylim = c(0, 50), xlab = "Age", ylab = "Gene expression")
legend("topleft", legend = c("Group 1", "Group 2"), pch = c(19, 19), col = c("red", "green"))
points(x, gene2, col = "green", pch = 19)
abline(-1, 7, col = "red")
abline(7, 7, col = "green")
```

---
## Power of design matrices

- We need to expand our model like $y = group1\_intercept + group2\_offset + slope$ - full model

- So, in our design matrix, first columns of 1's mean that both lines intercept the Y-axis, and specify the intercept for group 1

- The second column indicates the offset of group 2 measures

- The third column is the Age variable for each group

```
1  0  1
1  0  2
1  0  3
1  0  4
1  1  1
1  1  2
1  1  3
1  1  4
```

---
## Power of design matrices

- We need to expand our model like $y = group1\_intercept + group2\_offset + slope$ - full model

- So, in our design matrix, first columns of 1's mean that both lines intercept the Y-axis, and specify the intercept for group 1

- The second column indicates the offset of group 2 measures

- The third column is the Age variable for each group

- Compare with the simple model $y = overall\_mean$

- Calculate how much better is the full model: $F = \frac{ (SS_{simple} - SS_{full}) / (p_{full} - p_{simple}) }{SS_{full} / (n - p_{simple})}$ 

---
## Batch effect

- Suppose you have measurements from two labs

```{r echo=FALSE, fig.height=5, fig.align='center'}
set.seed(1)
gene1 <- rnorm(4, 5)
gene2 <- rnorm(4, 10)
gene3 <- rnorm(4, 3)
gene4 <- rnorm(4, 7)
x <- c(rep(1, 4), rep(2, 4), rep(3, 4), rep(4, 4))
plot(x, c(gene1, gene2, gene3, gene4), xlim = c(0, 5), ylim = c(0, 15), xlab = ("Status (\"/\" - different labs): 1/3 - normal, 2/4 - tumor"), ylab = "Gene expression")
```

---
## Batch effect

- First, add a term for the first lab normal group mean

```{r echo=FALSE, fig.height=5, fig.align='center'}
plot(x, c(gene1, gene2, gene3, gene4), xlim = c(0, 5), ylim = c(0, 15), xlab = ("Status (\"/\" - different labs): 1/3 - normal, 2/4 - tumor"), ylab = "Gene expression")
abline(h = mean(c(gene1, gene2, gene3, gene4)))
```

---
## Batch effect

- Second, add a term for the offset in measurements by the second lab

```{r echo=FALSE, fig.height=5, fig.align='center'}
plot(x, c(gene1, gene2, gene3, gene4), xlim = c(0, 5), ylim = c(0, 15), xlab = ("Status (\"/\" - different labs): 1/3 - normal, 2/4 - tumor"), ylab = "Gene expression")
abline(h = mean(c(gene1, gene2, gene3, gene4)))
lines(x = c(2.5, 4.5), y = c(mean(c(gene3, gene4)), mean(c(gene3, gene4))))
```

---
## Batch effect

- Third, add a term for the offset of the tumor measurements

```{r echo=FALSE, fig.height=5, fig.align='center'}
plot(x, c(gene1, gene2, gene3, gene4), xlim = c(0, 5), ylim = c(0, 15), xlab = ("Status (\"/\" - different labs): 1/3 - normal, 2/4 - tumor"), ylab = "Gene expression")
abline(h = mean(c(gene1, gene2, gene3, gene4)))
lines(x = c(2.5, 4.5), y = c(mean(c(gene3, gene4)), mean(c(gene3, gene4))))
lines(x = c(1.5, 2.5), y = c(mean(c(gene2)), mean(c(gene2))))
lines(x = c(3.5, 4.5), y = c(mean(c(gene4)), mean(c(gene4))))
```

---
## Batch effect

- The final model:
$$y = lab1\_normal\_mean + lab2\_offset + difference_{tumor - normal}$$ 
and the design matrix:

```
1  0  0
1  0  0
1  0  0
1  0  0
1  0  1
1  0  1
1  0  1
1  0  1
1  1  0
1  1  0
1  1  0
1  1  0
1  1  1
1  1  1
1  1  1
1  1  1
```

---
## Batch effect

- The final model:
$$y = lab1\_normal\_mean + lab2\_offset + difference_{tumor - normal}$$ 

- Does the lab effect matter? 

- Compare the final model with a simpler one $y = lab1\_normal\_mean + difference_{tumor - normal}$
